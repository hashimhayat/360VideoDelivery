<h1 style="display: none">Receiver</h1>

<style>
    .rect {
        width: 80px;
        height: 80px;
        position: absolute;
        left: -1000px;
        top: -1000px;
    }
</style>

<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/0.6.0/aframe-master.js"></script> -->

<div style="display: none">Status: <span id="connection" >Disconnected.</span><br><br></div>

<video id="video" src="https://ucarecdn.com/fadab25d-0b3a-45f7-8ef5-85318e92a261/"
               autoplay loop crossorigin="anonymous"></video>

<!-- <a-scene>
    <a-assets>
        <video id="video" src="https://ucarecdn.com/fadab25d-0b3a-45f7-8ef5-85318e92a261/" style="width: 80%; height: 80%;"
               autoplay loop crossorigin="anonymous"></video>
    </a-assets>
    <a-videosphere src="#video" rotation="0 180 0"></a-videosphere>
</a-scene> -->

<div class="console">
    <b>Frame Sent at:</b> <span id="flasedAt"></span><br>
    <b>Frame Received at:</b> <span id="receivedAt"></span><br>
    <b>Socket Latency:</b> <span id="socketDelay"></span><br>
    <b>Tracker Latency:</b> <span id="trackerDelay"></span><br>
    <b>End-to-End Delay:</b> <span id="delay"></span><br>
</div>

<script src="/javascripts/receiver.js" charset="utf-8"></script>
<script src="/javascripts/tracking-min.js"></script>

<script>

    const socket = io();

    var flashedAt = document.getElementById('flasedAt');
    var receivedAt = document.getElementById('receivedAt');
    var sDelay = document.getElementById('socketDelay');
    var tDelay = document.getElementById('trackerDelay');
    var delayDiv = document.getElementById('delay');


    window.onload = function() {

        var video = document.getElementById('video');
        var colors = new tracking.ColorTracker(['magenta']);

        var frameSent = undefined;
        var signalReceived = undefined;
        var socketDelay = undefined;
        var trackerDelay = undefined;
        var frameReceived = undefined;
        var eteDelay = undefined;

        socket.on('flashed', function(time) {
            frameSent = time;
            signalReceived = Date.now();
            socketDelay = signalReceived - frameSent;
            console.log("Flashed at: ", time, "Socket Latency: ", socketDelay);
        });

        colors.on('track', function(event) {            
            if (event.data.length > 0) {

                if (signalReceived){

                    frameReceived = Date.now();
                    trackerDelay = frameReceived - signalReceived;
                    eteDelay = (frameReceived - frameSent) - trackerDelay;
                    
                    console.log("Tracker Delay: ", trackerDelay);
                    console.log("Delay: ", eteDelay); 
                    signalReceived = undefined;
                    frameSent = undefined;

                } 
            }
        });

        flashedAt.innerHTML = frameSent;
        receivedAt.innerHTML = signalReceived;
        sDelay.innerHTML = socketDelay + ' ms';
        tDelay.innerHTML = trackerDelay + ' ms';
        delayDiv.innerHTML = eteDelay + ' ms';

        tracking.track('#video', colors);
    };
</script>

